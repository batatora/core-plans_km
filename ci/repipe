#!/bin/bash

echo "Rebuilding habitat-core-plans pipeline. This takes a while (>5 minutes). Just wait!"

PIPELINE=$(cd $(dirname ${BASH_SOURCE[0]}) ; pwd)
hab_origin=core

pushd $PIPELINE >/dev/null
  rm -rf packages
  mkdir packages deps
  for package in $(find .. -d -maxdepth 1); do
    if [[ -f ${package}/plan.sh ]]; then
      package_name=$(basename ${package})
      source ${package}/plan.sh

      for dep in "${pkg_deps[@]}"; do
        unset version
        unset version_key
        dep_origin=$(dirname ${dep})
        dep_name=$(basename ${dep})

        if [[ $(dirname ${dep_origin}) != "." ]]; then
          version_entry="    version: ${dep_name}"
          version="-${dep_name}"
          dep_name="$(basename ${dep_origin})"
          dep_origin=$(dirname ${dep_origin})
        fi

        cat > deps/${package_name}-${dep_origin}-${dep_name}${version}-dep.yml <<EOF
jobs:
- name: build-${package_name}
  plan:
  - (( inline ))
  - aggregate:
    - (( append ))
    - {get: ${dep_origin}-${dep_name}${version}, trigger: true}

resources:
- name: ${dep_origin}-${dep_name}${version}
  type: hab-pkg
  source:
    origin: ${dep_origin}
    name: ${dep_name}
${version_entry}
EOF
      done
      cat > packages/${package_name}.yml <<EOF
---
groups:
- name: packages
  jobs:
  - (( append ))
  - build-${package_name}

jobs:
- name: build-${package_name}
  public: true
  plan:
  - (( append ))
  - {get: ${package_name}-plan, trigger: true}
  - task: build-${package_name}
    privileged: true
    config:
      platform: linux
      image: docker:///starkandwayne/habitat-plans-pipeline
      inputs:
      - name: ${package_name}-plan
      outputs:
      - name: result
      run:
        path: ./${package_name}-plan/ci/scripts/build
      params:
        PACKAGE_CONTEXT: ${package_name}-plan/${package_name}
        OUT: result
        HAB_ORIGIN: ${hab_origin}
        HAB_ORIGIN_KEY: (( grab meta.habitat.origin_key ))
  - put: ${hab_origin}-${package_name}
    params:
      result: result

resources:
- name: ${hab_origin}-${package_name}
  type: hab-pkg
  source:
    origin: ${hab_origin}
    name: ${package_name}
    auth_token: (( grab meta.habitat.auth_token ))

- name: ${package_name}-plan
  type: git
  source:
    uri: https://github.com/starkandwayne/habitat-plans.git
    paths: [${package_name}/*]
EOF
    fi
  done

  trap "rm -f ${PIPELINE}/.deploy.yml" INT QUIT TERM EXIT
  spruce merge base.yml deps/*.yml packages/*.yml > .deploy.yml  && \
    REDACT=yes spruce merge --prune meta base.yml deps/*.yml packages/*.yml > pipeline.yml && \
    fly --target sw set-pipeline --pipeline habitat-core-plans --config .deploy.yml     &&
    fly --target sw unpause-pipeline --pipeline habitat-core-plans

  rm -rf packages deps
popd >/dev/null
